// Generated by CoffeeScript 1.9.3
(function() {
  var TimelineController, async,
    bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  async = require('async');

  TimelineController = (function() {
    function TimelineController($scope) {
      var container, options;
      this.$scope = $scope;
      this._onResize = bind(this._onResize, this);
      this._onWatchProfitLogs = bind(this._onWatchProfitLogs, this);
      this._onWatchNotes = bind(this._onWatchNotes, this);
      this._onWatchPersons = bind(this._onWatchPersons, this);
      this.$scope.timelineItems = new vis.DataSet();
      this.$scope.timelineGroups = new vis.DataSet();
      container = document.getElementById('timeline');
      options = {
        margin: {
          item: 5
        },
        height: window.innerHeight - 80,
        orientation: {
          axis: 'both',
          item: 'top'
        }
      };
      this.$scope.timeline = new vis.Timeline(container, this.$scope.timelineItems, this.$scope.timelineGroups, options);
      this.$scope.$watchCollection('persons', this._onWatchPersons);
      this.$scope.$watchCollection('notes', this._onWatchNotes);
      this.$scope.$watchCollection('timeLogs', this._onWatchNotes);
      this.$scope.$watchCollection('profitLogs', this._onWatchProfitLogs);
      this.$scope.$on('resize::resize', this._onResize);
    }

    TimelineController.prototype._onWatchPersons = function(newPersons, oldPersons) {
      var key, person;
      this.$scope.timelineGroups.clear();
      for (key in newPersons) {
        person = newPersons[key];
        this.$scope.timelineGroups.add({
          id: key,
          content: person
        });
      }
      return this.$scope.timelineGroups.add({
        id: 'updated',
        content: 'Update'
      });
    };

    TimelineController.prototype._onWatchNotes = function() {
      var end, i, j, len, len1, note, ref, ref1, results, start, timeLog;
      this.$scope.timelineItems.clear();
      ref = this.$scope.notes;
      for (i = 0, len = ref.length; i < len; i++) {
        note = ref[i];
        this.$scope.timelineItems.add({
          id: note.guid,
          group: 'updated',
          content: note.title,
          start: new Date(note.updated),
          type: 'point'
        });
      }
      ref1 = this.$scope.timeLogs;
      results = [];
      for (j = 0, len1 = ref1.length; j < len1; j++) {
        timeLog = ref1[j];
        start = new Date(timeLog.date);
        if (timeLog.spentTime) {
          end = new Date(start);
          end.setMinutes(start.getMinutes() + timeLog.spentTime);
        } else {
          end = null;
        }
        results.push(this.$scope.timelineItems.add({
          id: timeLog._id,
          group: timeLog.person,
          content: this.$scope.notes[timeLog.noteGuid].title + ' ' + timeLog.comment,
          start: start,
          end: end,
          type: end ? 'range' : 'point'
        }));
      }
      return results;
    };

    TimelineController.prototype._onWatchProfitLogs = function(newProfitLogs, oldProfitLogs) {};

    TimelineController.prototype._onResize = function(event) {
      return this.$scope.timeline.setOptions({
        height: window.innerHeight - 90
      });
    };

    return TimelineController;

  })();

  app.controller('TimelineController', ['$scope', TimelineController]);

  module.exports = TimelineController;

}).call(this);

//# sourceMappingURL=timeline-controller.js.map
