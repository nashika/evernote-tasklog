// Generated by CoffeeScript 1.10.0
(function() {
  var DataTranscieverService, async, merge,
    bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; };

  async = require('async');

  merge = require('merge');

  DataTranscieverService = (function() {

    /**
     * @public
     * @type {Object}
     */
    DataTranscieverService.prototype.filterParams = null;


    /**
     * @constructor
     * @param {$HttpProvider} $http
     * @param {DataStoreService} dataStore
     * @param {ProgressService} progress
     */

    function DataTranscieverService($http, dataStore, progress) {
      this.$http = $http;
      this.dataStore = dataStore;
      this.progress = progress;
      this._makeTimeLogQuery = bind(this._makeTimeLogQuery, this);
      this._makeNoteQuery = bind(this._makeNoteQuery, this);
      this.countTimeLogs = bind(this.countTimeLogs, this);
      this.countNotes = bind(this.countNotes, this);
      this.reload = bind(this.reload, this);
      this.filterParams = {
        notebookGuids: [],
        stacks: []
      };
    }


    /**
     * @public
     * @param {function} callback
     */

    DataTranscieverService.prototype.reload = function(params, callback) {
      var noteCount, noteQuery;
      if (params == null) {
        params = {};
      }
      if (!callback) {
        callback = (function(_this) {
          return function() {};
        })(this);
      }
      noteQuery = this._makeNoteQuery(params != null ? params : {});
      noteCount = 0;
      this.progress.open();
      return async.series([
        (function(_this) {
          return function(callback) {
            if (_this.dataStore.user) {
              return callback();
            }
            _this.progress.set('Getting user data.', 0);
            return _this.$http.get('/user').success(function(data) {
              _this.dataStore.user = data;
              return callback();
            }).error(function() {
              return callback('Error $http request');
            });
          };
        })(this), (function(_this) {
          return function(callback) {
            _this.progress.set('Getting settings data.', 10);
            return _this.$http.get('/settings').success(function(data) {
              _this.dataStore.settings = data;
              return callback();
            }).error(function() {
              return callback('Error $http request');
            });
          };
        })(this), (function(_this) {
          return function(callback) {
            if (!_this.dataStore.settings.persons || _this.dataStore.settings.persons.length === 0) {
              return callback('This app need persons setting. Please switch "Settings Page" and set your persons data.');
            }
            return callback();
          };
        })(this), (function(_this) {
          return function(callback) {
            _this.progress.set('Syncing remote server.', 20);
            return _this.$http.get('/sync').success(function() {
              return callback();
            }).error(function() {
              return callback('Error $http request');
            });
          };
        })(this), (function(_this) {
          return function(callback) {
            _this.progress.set('Getting notebooks data.', 30);
            return _this.$http.get('/notebooks').success(function(data) {
              var i, len, notebook, stackHash;
              _this.dataStore.notebooks = {};
              stackHash = {};
              for (i = 0, len = data.length; i < len; i++) {
                notebook = data[i];
                _this.dataStore.notebooks[notebook.guid] = notebook;
                if (notebook.stack) {
                  stackHash[notebook.stack] = true;
                }
              }
              _this.dataStore.stacks = Object.keys(stackHash);
              return callback();
            }).error(function() {
              return callback('Error $http request');
            });
          };
        })(this), (function(_this) {
          return function(callback) {
            _this.progress.set('Getting notes count.', 40);
            return _this.$http.get('/notes/count', {
              params: {
                query: noteQuery
              }
            }).success(function(data) {
              noteCount = data;
              if (noteCount > 100) {
                if (window.confirm("Current query find " + noteCount + " notes. It is too many. Continue anyway?")) {
                  return callback();
                } else {
                  return callback('User Canceled');
                }
              } else {
                return callback();
              }
            }).error(function() {
              return callback('Error $http request');
            });
          };
        })(this), (function(_this) {
          return function(callback) {
            _this.progress.set('Request remote contents.', 50);
            return _this.$http.get('/notes/get-content', {
              params: {
                query: noteQuery
              }
            }).success(function() {
              return callback();
            }).error(function() {
              return callback('Error $http request');
            });
          };
        })(this), (function(_this) {
          return function(callback) {
            _this.progress.set('Getting notes.', 70);
            return _this.$http.get('/notes', {
              params: {
                query: noteQuery,
                content: false
              }
            }).success(function(data) {
              var i, len, note;
              _this.dataStore.notes = {};
              for (i = 0, len = data.length; i < len; i++) {
                note = data[i];
                _this.dataStore.notes[note.guid] = note;
              }
              return callback();
            }).error(function() {
              return callback('Error $http request');
            });
          };
        })(this), (function(_this) {
          return function(callback) {
            var guids, note, noteGuid, timeLogQuery;
            _this.progress.set('Getting time logs.', 80);
            guids = (function() {
              var ref, results;
              ref = this.dataStore.notes;
              results = [];
              for (noteGuid in ref) {
                note = ref[noteGuid];
                results.push(note.guid);
              }
              return results;
            }).call(_this);
            timeLogQuery = _this._makeTimeLogQuery(merge(true, params, {
              noteGuids: guids
            }));
            return _this.$http.post('/time-logs', {
              query: timeLogQuery
            }).success(function(data) {
              var base, i, len, name, timeLog;
              _this.dataStore.timeLogs = {};
              for (i = 0, len = data.length; i < len; i++) {
                timeLog = data[i];
                if ((base = _this.dataStore.timeLogs)[name = timeLog.noteGuid] == null) {
                  base[name] = {};
                }
                _this.dataStore.timeLogs[timeLog.noteGuid][timeLog._id] = timeLog;
              }
              return callback();
            }).error(function() {
              return callback('Error $http request');
            });
          };
        })(this), (function(_this) {
          return function(callback) {
            var guids, note, noteGuid;
            _this.progress.set('Getting profit logs.', 90);
            guids = (function() {
              var ref, results;
              ref = this.dataStore.notes;
              results = [];
              for (noteGuid in ref) {
                note = ref[noteGuid];
                results.push(note.guid);
              }
              return results;
            }).call(_this);
            return _this.$http.post('/profit-logs', {
              query: {
                noteGuid: {
                  $in: guids
                }
              }
            }).success(function(data) {
              var base, i, len, name, profitLog;
              _this.dataStore.profitLogs = {};
              for (i = 0, len = data.length; i < len; i++) {
                profitLog = data[i];
                if ((base = _this.dataStore.profitLogs)[name = profitLog.noteGuid] == null) {
                  base[name] = {};
                }
                _this.dataStore.profitLogs[profitLog.noteGuid][profitLog._id] = profitLog;
              }
              return callback();
            }).error(function() {
              return callback('Error $http request');
            });
          };
        })(this)
      ], (function(_this) {
        return function(err) {
          if (err) {
            alert(err);
          } else {
            _this.progress.set('Done.', 100);
          }
          _this.progress.close();
          return callback(err);
        };
      })(this));
    };

    DataTranscieverService.prototype.reParse = function(callback) {
      if (!callback) {
        callback = (function(_this) {
          return function() {};
        })(this);
      }
      this.progress.open();
      this.progress.set('Re Parse notes...', 50);
      return async.waterfall([
        (function(_this) {
          return function(callback) {
            return _this.$http.get('/notes/re-parse').success(function(data) {
              return callback();
            }).error(function(data) {
              return callback('Error $http request');
            });
          };
        })(this)
      ], (function(_this) {
        return function(err) {
          _this.progress.set('Done.', 100);
          _this.progress.close();
          return callback(err);
        };
      })(this));
    };

    DataTranscieverService.prototype.countNotes = function(callback) {
      var query;
      query = this._makeNoteQuery();
      return this.$http.get('/notes/count', {
        params: {
          query: query
        }
      }).success((function(_this) {
        return function(data) {
          return callback(null, data);
        };
      })(this)).error((function(_this) {
        return function() {
          return callback('Error $http request');
        };
      })(this));
    };

    DataTranscieverService.prototype.countTimeLogs = function(callback) {
      var query;
      query = this._makeTimeLogQuery();
      return this.$http.get('/time-logs/count', {
        params: {
          query: query
        }
      }).success((function(_this) {
        return function(data) {
          return callback(null, data);
        };
      })(this)).error((function(_this) {
        return function() {
          return callback('Error $http request');
        };
      })(this));
    };


    /**
     * @protected
     * @param {Object} params
     * @return {Object}
     */

    DataTranscieverService.prototype._makeNoteQuery = function(params) {
      var i, j, len, len1, notebook, notebookGuid, notebooksArray, notebooksHash, ref, ref1, ref2, result, stack;
      if (params == null) {
        params = {};
      }
      result = {};
      if (params.start) {
        merge(result, {
          updated: {
            $gte: params.start.valueOf()
          }
        });
      }
      notebooksHash = {};
      if (this.filterParams.notebookGuids && this.filterParams.notebookGuids.length > 0) {
        ref = this.filterParams.notebookGuids;
        for (i = 0, len = ref.length; i < len; i++) {
          notebookGuid = ref[i];
          notebooksHash[notebookGuid] = true;
        }
      }
      if (this.filterParams.stacks && this.filterParams.stacks.length > 0) {
        ref1 = this.filterParams.stacks;
        for (j = 0, len1 = ref1.length; j < len1; j++) {
          stack = ref1[j];
          ref2 = this.dataStore.notebooks;
          for (notebookGuid in ref2) {
            notebook = ref2[notebookGuid];
            if (stack === notebook.stack) {
              notebooksHash[notebook.guid] = true;
            }
          }
        }
      }
      notebooksArray = Object.keys(notebooksHash);
      if (notebooksArray.length > 0) {
        merge(result, {
          notebookGuid: {
            $in: notebooksArray
          }
        });
      }
      return result;
    };


    /**
     * @public
     * @param {Object} params
     * @return {Object}
     */

    DataTranscieverService.prototype._makeTimeLogQuery = function(params) {
      var result;
      if (params == null) {
        params = {};
      }
      result = {};
      if (params.start) {
        merge.recursive(result, {
          date: {
            $gte: params.start.valueOf()
          }
        });
      }
      if (params.end) {
        merge.recursive(result, {
          date: {
            $lte: params.end.valueOf()
          }
        });
      }
      if (params.noteGuids) {
        merge(result, {
          noteGuid: {
            $in: params.noteGuids
          }
        });
      }
      return result;
    };

    return DataTranscieverService;

  })();

  app.service('dataTransciever', ['$http', 'dataStore', 'progress', DataTranscieverService]);

  module.exports = DataTranscieverService;

}).call(this);

//# sourceMappingURL=data-transciever.js.map
