// Generated by CoffeeScript 1.9.3
(function() {
  var Model, MultiModel, async, core, merge,
    bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; },
    extend = function(child, parent) { for (var key in parent) { if (hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },
    hasProp = {}.hasOwnProperty,
    slice = [].slice;

  async = require('async');

  merge = require('merge');

  core = require('../core');

  Model = require('./Model');

  MultiModel = (function(superClass) {
    extend(MultiModel, superClass);

    function MultiModel() {
      this.removeLocal = bind(this.removeLocal, this);
      this.saveLocalUpdateOnly = bind(this.saveLocalUpdateOnly, this);
      this.saveLocal = bind(this.saveLocal, this);
      this.__parseFindOptions = bind(this.__parseFindOptions, this);
      this.countLocal = bind(this.countLocal, this);
      this.findLocal = bind(this.findLocal, this);
      return MultiModel.__super__.constructor.apply(this, arguments);
    }


    /**
     * @const
     * @type {Object}
     */

    MultiModel.prototype.DEFAULT_QUERY = {};


    /**
     * @const
     * @type {Object}
     */

    MultiModel.prototype.APPEND_QUERY = {};


    /**
     * @const
     * @type {Object}
     */

    MultiModel.prototype.DEFAULT_SORT = {
      updated: -1
    };


    /**
     * @const
     * @type {Object}
     */

    MultiModel.prototype.APPEND_SORT = {};


    /**
     * @const
     * @type {number}
     */

    MultiModel.prototype.DEFAULT_LIMIT = 50;


    /**
     * @public
     * @param {Object} options
     * @param {function} callback
     */

    MultiModel.prototype.findLocal = function(options, callback) {
      options = this.__parseFindOptions(options);
      core.loggers.system.debug("Find local " + this.PLURAL_NAME + " was started. query=" + (JSON.stringify(options.query)) + ", sort=" + (JSON.stringify(options.sort)) + ", limit=" + options.limit);
      return this._datastore.find(options.query).sort(options.sort).limit(options.limit).exec((function(_this) {
        return function(err, docs) {
          core.loggers.system.debug("Find local " + _this.PLURAL_NAME + " was " + (err ? 'failed' : 'succeed') + ". docs.length=" + docs.length);
          return callback(err, docs);
        };
      })(this));
    };


    /**
     * @public
     * @param {Object} options
     * @param {function} callback
     */

    MultiModel.prototype.countLocal = function(options, callback) {
      options = this.__parseFindOptions(options);
      core.loggers.system.debug("Count local " + this.PLURAL_NAME + " was started. query=" + (JSON.stringify(options.query)));
      return this._datastore.count(options.query, (function(_this) {
        return function(err, count) {
          core.loggers.system.debug("Count local " + _this.PLURAL_NAME + " was " + (err ? 'failed' : 'succeed') + ". count=" + count);
          return callback(err, count);
        };
      })(this));
    };


    /**
     * @private
     * @param {Object} options
     * @return {Object}
     */

    MultiModel.prototype.__parseFindOptions = function(options) {
      var i, key, len, ref, ref1, ref2, ref3, result;
      result = {};
      result.query = (ref = options.query) != null ? ref : merge(true, this.DEFAULT_QUERY);
      result.sort = (ref1 = options.sort) != null ? ref1 : merge(true, this.DEFAULT_SORT);
      result.limit = (ref2 = options.limit) != null ? ref2 : this.DEFAULT_LIMIT;
      ref3 = ['query', 'sort'];
      for (i = 0, len = ref3.length; i < len; i++) {
        key = ref3[i];
        result[key] = (function() {
          switch (typeof result[key]) {
            case 'object':
              return result[key];
            case 'string':
              return JSON.parse(result[key]);
            default:
              return {};
          }
        })();
      }
      merge(result.query, this.APPEND_QUERY);
      merge(result.sort, this.APPEND_SORT);
      return result;
    };


    /**
     * @public
     * @param {Array.<Object>|Object} docs
     * @param {function} callback
     */

    MultiModel.prototype.saveLocal = function(docs, callback) {
      if (!docs || docs.length === 0) {
        return callback();
      }
      if (!Array.isArray(docs)) {
        docs = [docs];
      }
      core.loggers.system.debug("Save local " + this.PLURAL_NAME + " was started. docs.count=" + docs.length);
      return async.eachSeries(docs, (function(_this) {
        return function(doc, callback) {
          core.loggers.system.trace("Upsert local " + _this.PLURAL_NAME + " was started. guid=" + doc.guid + ", title=" + doc[_this.TITLE_FIELD]);
          return _this._datastore.update({
            guid: doc.guid
          }, doc, {
            upsert: true
          }, function(err, numReplaced, newDoc) {
            core.loggers.system.trace("Upsert local " + _this.PLURAL_NAME + " was " + (err ? 'failed' : 'succeed') + ". guid=" + doc.guid + ", numReplaced=" + numReplaced);
            return callback(err);
          });
        };
      })(this), (function(_this) {
        return function(err) {
          core.loggers.system.debug("Save local " + _this.PLURAL_NAME + " was " + (err ? 'failed' : 'succeed') + ". docs.count=" + docs.length);
          return callback(err);
        };
      })(this));
    };


    /**
     * @public
     * @param {Array.<Object>|Object} docs
     * @param {function} callback
     */

    MultiModel.prototype.saveLocalUpdateOnly = function(docs, callback) {
      if (!docs || docs.length === 0) {
        return callback();
      }
      if (!Array.isArray(docs)) {
        docs = [docs];
      }
      core.loggers.system.debug("Save local update only " + this.PLURAL_NAME + " was started. docs.count=" + docs.length);
      return async.eachSeries(docs, (function(_this) {
        return function(doc, callback) {
          var localDoc;
          localDoc = null;
          return async.waterfall([
            function(callback) {
              return _this._datastore.find({
                guid: doc.guid
              }, callback);
            }, function(docs, callback) {
              localDoc = docs.length === 0 ? null : docs[0];
              if (localDoc && localDoc.updateSequenceNum >= doc.updateSequenceNum) {
                core.loggers.system.trace("Upsert local " + _this.PLURAL_NAME + " was skipped. guid=" + doc.guid + ", title=" + doc[_this.TITLE_FIELD]);
                return callback();
              } else {
                core.loggers.system.trace("Upsert local " + _this.PLURAL_NAME + " was started. guid=" + doc.guid + ", title=" + doc[_this.TITLE_FIELD]);
                return async.waterfall([
                  function(callback) {
                    return _this._datastore.db[_this.PLURAL_NAME].update({
                      guid: doc.guid
                    }, doc, {
                      upsert: true
                    }, callback);
                  }, function() {
                    var callback, i, newDoc, numReplaced;
                    numReplaced = arguments[0], newDoc = 3 <= arguments.length ? slice.call(arguments, 1, i = arguments.length - 1) : (i = 1, []), callback = arguments[i++];
                    core.loggers.system.trace("Upsert local " + _this.PLURAL_NAME + " was succeed. guid=" + doc.guid + ", numReplaced=" + numReplaced);
                    return callback();
                  }
                ], callback);
              }
            }
          ], callback);
        };
      })(this), (function(_this) {
        return function(err) {
          core.loggers.system.debug("Save local update only " + _this.PLURAL_NAME + " was " + (err ? 'failed' : 'succeed') + ". docs.count=" + docs.length);
          return callback(err);
        };
      })(this));
    };


    /**
     * @public
     * @param {Array.<string>|string|Object} query
     * @param {function} callback
     */

    MultiModel.prototype.removeLocal = function(query, callback) {
      if (!query) {
        return callback();
      }
      if (Array.isArray(query)) {
        if (query.length === 0) {
          callback();
        }
        query = {
          guid: {
            $in: query
          }
        };
      }
      if (typeof query === 'string') {
        query = {
          guid: query
        };
      }
      core.loggers.system.debug("Remove local " + this.PLURAL_NAME + " was started. query=" + (JSON.stringify(query)));
      return this._datastore.remove(query, {
        multi: true
      }, (function(_this) {
        return function(err, numRemoved) {
          core.loggers.system.debug("Remove local " + _this.PLURAL_NAME + " was " + (err ? 'failed' : 'succeed') + ". numRemoved=" + numRemoved);
          return callback(err);
        };
      })(this));
    };

    return MultiModel;

  })(Model);

  module.exports = MultiModel;

}).call(this);

//# sourceMappingURL=multi-model.js.map
